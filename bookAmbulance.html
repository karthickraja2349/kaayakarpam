<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaayakarpam - Ambulance Booking</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
    crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: black;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            overflow: hidden;
            background-color : white;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .request-container {
            padding: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: green;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .booking-type {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 15px 0;
        }
        
        .booking-type input[type="radio"] {
            display: none;
        }
        
        .booking-type label {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .booking-type input[type="radio"]:checked + label {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .booking-type label i {
            margin-right: 8px;
        }
        
        .map-area {
            margin: 25px 0;
        }
        
        #map-container {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            height: 300px;
            margin-top: 10px;
            border: 2px solid #ddd;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .map-instructions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 14px;
        }
        
        .coordinates-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        .input-group input {
            background: #f8f9fa;
        }
        
        .error {
            color: #e74c3c;
            text-align: center;
            margin: 15px 0;
            font-weight: 500;
            min-height: 20px;
        }
        
        button {
            background: #2c3e50;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #3498db;
        }
        
        @media (max-width: 600px) {
            .coordinates-display {
                grid-template-columns: 1fr;
            }
            
            .booking-type {
                flex-direction: column;
            }
        }
    </style>        
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-ambulance"></i> Emergency Ambulance Service</h1>
            <p>Quick and reliable ambulance booking for emergencies</p>
        </div>
        
        <div class="request-container">
            <form id="requestAmbulance" method="POST">
                <div class="form-group">
                <!--    <label for="location"><i class="fas fa-map-marker-alt"></i> Location</label>
                    <input type="text" id="location" name="location" placeholder="Enter the exact location of emergency" > -->
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-tag"></i> Emergency Type</label>
                    <div class="booking-type">
                        <input type="radio" id="critical" name="type" value="critical">
                        <label for="critical"><i class="fas fa-exclamation-circle"></i> Critical</label>
                        
                        <input type="radio" id="normal" name="type" value="normal">
                        <label for="normal"><i class="fas fa-info-circle"></i> Normal</label>
                        
                     <!--   <input type="radio" id="book" name="type" value="book">
                        <label for="book"><i class="fas fa-calendar-check"></i> Book</label> -->
                    </div>
                </div>
                
                <div class="form-group map-area">
                    <label><i class="fas fa-map"></i> Confirm Location on Map</label>
                    <div id="map-container">
                        <div id="map"></div>
                        <div class="map-instructions">
                            Click on the map to set the exact location
                        </div>
                    </div>
                </div>
                
                <div class="coordinates-display">
                    <div class="input-group">
                        <label for="latitude">Latitude</label>
                        <input type="text" id="latitude" name="latitude" readonly placeholder="Click on the map">
                    </div>
            
                    <div class="input-group">
                        <label for="longitude">Longitude</label>
                        <input type="text" id="longitude" name="longitude" readonly placeholder="Click on the map">
                    </div>
                </div>
                <div id="output"></div>
                <p class="error" id="error-msg"></p>

                <button type="submit"><i class="fas fa-paper-plane"></i> Request Ambulance</button>
            </form>    
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
    crossorigin=""></script>
    
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    
    <script>
        // Initialize the map
        const map = L.map('map').setView([9.9252, 78.1198], 8); // Default to Madurai
        let lastValidPosition = [9.9252, 78.1198]
        
         const indiaPolygonData = {
                  "type": "Feature",
                  "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                          [68.0, 8.0],   // SW corner (Gujarat coast)
                          [97.0, 8.0],   // SE (near Andaman excluded)
                          [97.0, 35.5],  // NE (Arunachal)
                          [68.0, 35.5],  // NW (Kashmir)
                          [68.0, 8.0]    // back to start
                        ]]
                   }
           };
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
      
        // Add a marker that can be dragged
        let marker = L.marker([9.9252, 78.1198], {
            draggable: true
        }).addTo(map);
        
        fetchHospitals().then(hospitals => {
            addHospitalsToMap(hospitals);
        }).catch(error => {
            console.error('Failed to load hospitals:', error);
        });
        
        // Update coordinates when marker is dragged or map is clicked
        function updateCoordinates(lat, lng) {
            document.getElementById('latitude').value = lat.toFixed(6);
            document.getElementById('longitude').value = lng.toFixed(6);
            lastValidPosition = [lat, lng]; 
        }
        
                   async function isLand(lat, lng) {
                  try {
                    const response = await fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lng}`);
                    const data = await response.json();
                    return data.results[0].elevation > 0; 
                  }
                  catch (error) {
                    console.error("Elevation API error:", error);
                    return true; 
                  }
             }
    /*         
         async function isInIndia(lat, lng) {
            
              const indiaBounds = {
                north: 37.6,  // Northernmost point
                south: 6.8,   // Southernmost point
                east: 97.4,   // Easternmost point
                west: 68.1    // Westernmost point
              };
              return (
                lat >= indiaBounds.south &&
                lat <= indiaBounds.north &&
                lng >= indiaBounds.west &&
                lng <= indiaBounds.east
              );
        }
        */
        async function isInIndia(lat, lng) {
            const point = turf.point([lng, lat]);
            return turf.booleanPointInPolygon(point, indiaPolygonData);
          }
        
        // Event when map is clicked
        map.on('click', async function(event) {
            const {lat, lng} = event.latlng;
            const onLand =  await isLand(lat, lng);
            const inInsideIndia = await isInIndia(lat, lng);
            if (!onLand) {
              //    alert("Please select a location on land. This appears to be water.");
                  return;
            }
            if(!inInsideIndia){
                alert("Please select a location Inside  India. This appears Outside India.");
                return;
            }    
            marker.setLatLng([lat, lng]);
            updateCoordinates(lat, lng);
        });
        
         const hospitalIcon = L.divIcon({
              className: "custom-hospital-icon",
              html: "<div style='color: red; font-size: 28px; font-weight: bold;'>üè•</div>",
              iconSize: [30, 30],
              iconAnchor: [15, 15],
              popupAnchor: [0, -20]
            });
        /*    
             const hospitals = [
    { lat: 8.173993, lng: 77.409270, name: "GM Hospital" },
    { lat: 8.965097, lng: 77.069791, name: "MNM hospital" }, 
    { lat: 8.163993, lng: 77.409270, name: "NP Hospital" }, 
    { lat: 8.156023, lng: 77.463944, name: "Ak Hospital" }, 
    { lat: 8.718664, lng: 77.742237, name: "GH TLY" },
    { lat: 9.482787, lng: 76.845676, name: "Arya Hospital (Service Not Available)"},
    { lat: 10.570678 , lng: 72.630865, name: "MK Hospital"},
    { lat: 11.612849 , lng: 92.701981, name: "cure Hospital"},
    { lat: 10.315994 , lng: 77.949996, name: "PEAK Hospital (Service Not Available)"},
    { lat: 10.086164 , lng: 78.772814, name: "PN Hospital (Service Not Available)"},
    { lat: 10.677558 , lng: 78.595023, name: "malai Hospital (Service Not Available)"},
    { lat: 9.450363 , lng: 77.791359, name: "kali Hospital"},
    { lat: 9.844963 , lng: 78.016303, name: "GH Madurai"},
     { lat: 9.450703 , lng: 77.554970, name: "GH Rajapalayam"},
    { lat: 10.390848 , lng: 77.964977, name: "MNPT Hospital (Service Not Available)"}
  ];
hospitals.forEach(h => {
    L.marker([h.lat, h.lng], { icon: hospitalIcon })
      .addTo(map)
      .bindPopup(`üè• ${h.name}<br>Lat: ${h.lat}, Lng: ${h.lng}`);
  });

     */             
        // Form validation
        document.getElementById('requestAmbulance').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const emergencyType = document.querySelector('input[name="type"]:checked');
               // const location = "N/A";
                const latitude = document.getElementById('latitude').value.trim();
                const longitude = document.getElementById('longitude').value.trim();
                const errorMsg = document.getElementById('error-msg');
                const output = document.getElementById('output');
                
              /*  if (!location) {
                    document.getElementById('location').value = "N/A"
                    return;
                }*/
                
                if (!emergencyType) {
                    errorMsg.textContent = 'Please select an emergency type';
                    return;
                }
                
                if (!latitude || !longitude) {
                    errorMsg.textContent = 'Please select a location on the map';
                    return;
                }
                
                const formData = new FormData();
              //  formData.append("location", location);
                formData.append("emergencyType", emergencyType.value); // Fixed
                formData.append("latitude", latitude);
                formData.append("longitude", longitude);
                
                try { 
                    const response = await fetch("/kaayakarpam/ambulanceRequest", {
                        method: "POST",
                        body: formData
                    });
                    
                    if(response.ok) {
                        const result = await response.text();
                        output.textContent = result;
                        //document.getElementById("location").value = '';
                        document.getElementById("latitude").value = '';
                        document.getElementById("longitude").value = '';
                        errorMsg.textContent = '';
                        
                        // Reset map to default position
                        marker.setLatLng([9.9252, 78.1198]);
                        map.setView([9.9252, 78.1198], 8);
                    } else {
                        errorMsg.textContent = "Something failed. Please try again.";
                    }
                } 
                catch(err) {
                    if(err.message.includes("Lock wait timeout exceeded; try restarting transaction")){
                           errorMsg.textContent = "Sorry , Ambulance Service Not available";
                          output.textContent = "Sorry! Please try again.";
                    }
                    else{
                          errorMsg.textContent = "Sorry: Ambulance Service Not available" ;
                          output.textContent = "Sorry! Please try again.";
                     }     
                }
            });
            
 
        
        // Event when marker is dragged
        marker.on('dragend', async function(event) {
            const position = marker.getLatLng();
            const onLand =  await isLand(position.lat, position.lng);
            const inInsideIndia = await isInIndia(position.lat, position.lng);
            
            if (!onLand) {
             alert("Markers cannot be placed in water. Returning to previous position.");
             marker.setLatLng(lastValidPosition);
             return;
            }
            
            if (!inInsideIndia) {
             alert("Markers cannot be placed Outside India. Returning to previous position.");
             marker.setLatLng(lastValidPosition);
             return;
            }
            
            updateCoordinates(position.lat, position.lng);
        });
/*
        map.on('click', async function(event) {
          const {lat, lng} = event.latlng;
        
          const onLand = await isLand(lat, lng);
          const inInsideIndia = await isInIndia(lat, lng);
          
          if (!onLand) {
            alert("Please select a location on land. This appears to be water.");
            return;
          }
          
          if(!inInsideIndia){
             alert("Services available only with in India.");
             return;
          }
          
        marker.setLatLng([lat, lng]);
        updateCoordinates(lat, lng);
     });
     */
     async function fetchHospitals() {
          try {
              const response = await fetch('/kaayakarpam/hospitalRetriver');
              if (!response.ok) {
                  throw new Error('Failed to fetch hospitals');
              }
              const hospitals = await response.json();
              return hospitals;
          } 
          catch (error) {
              console.error('Error fetching hospitals:', error);
              return [];
          }
      }
      
      function addHospitalsToMap(hospitals) {
          hospitals.forEach(hospital => {
              const marker = L.marker([hospital.latitude, hospital.longitude], { 
                  icon: hospitalIcon 
              }).addTo(map);
              
              
              const statusText = hospital.status === "Available" 
                  ? "<span style='color: green; font-weight: bold;'>Service Available</span>" 
                  : "<span style='color: red; font-weight: bold;'>Service Not Available</span>";
              
              marker.bindPopup(`
                  <div style="text-align: center;">
                      <h3 style="margin: 5px 0;">üè• ${hospital.hospitalName}</h3>
                      <h4 style = "margin : 3px 0;"> üìû ${hospital.mobileNumber}</h4>
                      <p>${statusText}</p>
                      <p>Lat: ${hospital.latitude}, Lng: ${hospital.longitude}</p>
                  </div>
              `);
          });
      }
    </script>
</body>
</html>
